<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Number of Articles Mentioning Selected Keywords Over Time</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .line {
            fill: none;
            stroke-width: 2px;
        }
        .axis-label {
            font-size: 12px;
            font-weight: 500;
        }
        .tooltip {
            position: absolute;
            padding: 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            pointer-events: none;
            font-size: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .tooltip strong {
            font-weight: 600;
        }
        text {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .legend-item {
            cursor: pointer;
        }
        .legend-item.inactive text {
            opacity: 0.5;
        }
        .legend-item.inactive rect {
            opacity: 0.5;
        }
        .hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <svg width="1200" height="600"></svg>
    <script>
        const svg = d3.select("svg"),
              margin = {top: 20, right: 150, bottom: 50, left: 60},
              width = +svg.attr("width") - margin.left - margin.right,
              height = +svg.attr("height") - margin.top - margin.bottom,
              g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        const parseYear = d3.timeParse("%Y");

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);
        const z = d3.scaleOrdinal(d3.schemeCategory10);

        const line = d3.line()
            .x(d => x(d.year))
            .y(d => y(d.total_count));

        d3.json("yearly_counts.json").then(data => {
            // Transform the data structure
            const transformedData = [];
            data.forEach(yearData => {
                yearData.keywords.forEach(keywordData => {
                    transformedData.push({
                        year: parseYear(yearData.year),
                        keyword: keywordData.keyword,
                        total_count: keywordData.total_count,
                        countries: keywordData.countries
                    });
                });
            });

            const keywords = Array.from(new Set(transformedData.map(d => d.keyword)));
            const dataNest = d3.groups(transformedData, d => d.keyword);

            x.domain(d3.extent(transformedData, d => d.year));
            y.domain([0, d3.max(transformedData, d => d.total_count)]);

            // Function to update the visualization
            function updateChart(activeKeywords) {
                // Filter data based on active keywords
                const activeData = transformedData.filter(d => activeKeywords.includes(d.keyword));
                
                // Update y scale domain based on active data
                const maxY = d3.max(activeData, d => d.total_count) || 0;
                y.domain([0, maxY]);

                // Update y-axis with transition
                g.select(".axis--y")
                    .transition()
                    .duration(750)
                    .call(d3.axisLeft(y));

                // Update lines with transition
                dataNest.forEach(([keyword, values]) => {
                    const isActive = activeKeywords.includes(keyword);
                    const lineId = `line-${keyword.replace(/\s+/g, '-')}`;
                    const dotsClass = `dots-${keyword.replace(/\s+/g, '-')}`;

                    // Update line
                    d3.select(`#${lineId}`)
                        .classed("hidden", !isActive)
                        .transition()
                        .duration(750)
                        .attr("d", line(values));

                    // Update dots
                    d3.selectAll(`.${dotsClass}`)
                        .classed("hidden", !isActive)
                        .transition()
                        .duration(750)
                        .attr("cy", d => y(d.total_count));
                });
            }

            // Add X axis
            g.append("g")
                .attr("class", "axis axis--x")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(d3.timeYear.every(2)))
                .selectAll("text")
                .attr("transform", "rotate(-45)")
                .style("text-anchor", "end");

            // Add X axis label
            g.append("text")
                .attr("class", "axis-label")
                .attr("text-anchor", "middle")
                .attr("x", width/2)
                .attr("y", height + margin.bottom - 5)
                .text("Year");

            // Add Y axis
            g.append("g")
                .attr("class", "axis axis--y")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("class", "axis-label")
                .attr("fill", "#000")
                .attr("transform", "rotate(-90)")
                .attr("y", -margin.left + 15)
                .attr("x", -height/2)
                .attr("text-anchor", "middle")
                .text("Number of Articles");

            // Add lines with unique IDs
            const keyword = g.selectAll(".keyword")
                .data(dataNest)
                .enter().append("g")
                .attr("class", "keyword");

            keyword.append("path")
                .attr("class", "line")
                .attr("id", d => `line-${d[0].replace(/\s+/g, '-')}`)
                .attr("d", d => line(d[1]))
                .style("stroke", d => z(d[0]));

            // Add dots with unique classes
            dataNest.forEach(keywordGroup => {
                const keywordClass = `dots-${keywordGroup[0].replace(/\s+/g, '-')}`;
                g.selectAll(`.${keywordClass}`)
                    .data(keywordGroup[1].filter(d => d.total_count > 0))
                    .enter().append("circle")
                    .attr("class", `dot ${keywordClass}`)
                    .attr("r", 4)
                    .attr("cx", d => x(d.year))
                    .attr("cy", d => y(d.total_count))
                    .style("fill", z(keywordGroup[0]))
                    .on("mouseover", function(event, d) {
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", .9);
                        
                        let tooltipContent = `<strong>${d.keyword}</strong><br/>`;
                        tooltipContent += `Year: ${d.year.getFullYear()}<br/>`;
                        tooltipContent += `Total: ${d.total_count}<br/><br/>`;
                        
                        if (d.countries.length > 0) {
                            tooltipContent += "<strong>By Country:</strong><br/>";
                            d.countries.forEach(country => {
                                tooltipContent += `${country.name}: ${country.count}<br/>`;
                            });
                        }
                        
                        tooltip.html(tooltipContent)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            });

            // Track active keywords
            const activeKeywords = new Set(keywords);

            // Add interactive legend
            const legend = svg.append("g")
                .attr("transform", `translate(${width + margin.right - 100},${margin.top})`);

            const legendItems = keywords.map(keyword => ({
                keyword: keyword,
                active: true
            }));

            const legendItem = legend.selectAll(".legend-item")
                .data(legendItems)
                .enter().append("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(0,${i * 20})`)
                .on("click", function(event, d) {
                    // Toggle active state
                    d.active = !d.active;
                    
                    // Update legend item appearance
                    d3.select(this)
                        .classed("inactive", !d.active);
                    
                    // Update active keywords set
                    if (d.active) {
                        activeKeywords.add(d.keyword);
                    } else {
                        activeKeywords.delete(d.keyword);
                    }
                    
                    // Update chart with active keywords
                    updateChart(Array.from(activeKeywords));
                });

            legendItem.append("rect")
                .attr("width", 10)
                .attr("height", 10)
                .style("fill", d => z(d.keyword));

            legendItem.append("text")
                .attr("x", 20)
                .attr("y", 9)
                .text(d => d.keyword);
        });
    </script>
</body>
</html>